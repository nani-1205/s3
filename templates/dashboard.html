{% extends "base.html" %}

{% block title %}Migration Dashboard{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Configuration Form -->
    <div class="form-card">
        <h2>ðŸš€ New Migration</h2>
        <!-- The form tag itself doesn't need an action/method since we handle it with JS -->
        <form id="migrationForm">
            <!-- Source Configuration -->
            <h3>Source Details</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="source_access_key">Source Access Key ID</label>
                    <input type="password" id="source_access_key" name="source_access_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
                <div class="form-group">
                    <label for="source_secret_key">Source Secret Access Key</label>
                    <input type="password" id="source_secret_key" name="source_secret_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="source_region">Source Region</label>
                    <input type="text" id="source_region" name="source_region" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="source_bucket">Source Bucket</label>
                    <input type="text" id="source_bucket" name="source_bucket" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="source_prefix">Source Prefix</label>
                    <input type="text" id="source_prefix" name="source_prefix" class="form-control">
                </div>
            </div>
            
            <!-- Destination Configuration -->
            <hr style="margin: 25px 0; border: 1px solid #eee;">
            <h3>Destination Details</h3>
            <div class="form-row">
                 <div class="form-group">
                    <label for="dest_access_key">Destination Access Key ID</label>
                    <input type="password" id="dest_access_key" name="dest_access_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
                <div class="form-group">
                    <label for="dest_secret_key">Destination Secret Access Key</label>
                    <input type="password" id="dest_secret_key" name="dest_secret_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="dest_region">Destination Region</label>
                    <input type="text" id="dest_region" name="dest_region" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="dest_bucket">Destination Bucket</label>
                    <input type="text" id="dest_bucket" name="dest_bucket" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="dest_prefix">Destination Prefix</label>
                    <input type="text" id="dest_prefix" name="dest_prefix" class="form-control">
                </div>
            </div>

            <!-- 
            ================================================================
            THE FIX IS HERE: Add type="button" to the button element
            ================================================================
            -->
            <button type="button" class="auth-button" id="startButton">Start Migration</button>

        </form>
    </div>

    <!-- Status & Logs -->
    <div class="status-card">
        <h2>Live Status</h2>
        <div class="stats-grid">
            <!-- Stats populated by JS -->
        </div>
        <div class="progress-section">
            <!-- Progress populated by JS -->
        </div>
        <div class="current-file" style="display: none;">
            <!-- Current file populated by JS -->
        </div>
        <div class="log-section">
            <div class="log-header">ðŸ“Š Migration Logs</div>
            <div id="logContainer"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    class S3MigrationDashboard {
        constructor() {
            this.form = document.getElementById('migrationForm');
            this.startButton = document.getElementById('startButton');
            // ... other elements
            
            this.init();
        }

        init() {
            // We listen to the button click, not the form submit event
            this.startButton.addEventListener('click', (event) => {
                this.triggerMigration();
            });

            // Rest of your JS class...
            // this.connectToStatusStream();
            // All other methods...
        }

        triggerMigration() {
            // ... existing triggerMigration logic ...
            
            // Serialize form data
            const formData = new FormData(this.form);

            fetch("{{ url_for('migration.trigger_migration') }}", { 
                method: 'POST',
                body: formData // Send the form data in the body of the POST request
            })
            // ... rest of the fetch logic
        }

        // ... PASTE THE REST OF YOUR S3MigrationDashboard JAVASCRIPT CLASS HERE ...
        // No other changes are needed in the JS class itself.
    }
    
    // Make sure you have the full JavaScript class here as provided in the previous response.
    // ...
</script>
{% endblock %}