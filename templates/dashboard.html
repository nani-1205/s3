{% extends "base.html" %}

{% block title %}Migration Dashboard{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Configuration Form -->
    <div class="form-card">
        <h2>ðŸš€ New Migration</h2>
        <!-- The form ID is critical for our JavaScript -->
        <form id="migrationForm">
            <!-- Source Configuration -->
            <h3>Source Details</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="source_access_key">Source Access Key ID</label>
                    <input type="password" id="source_access_key" name="source_access_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
                <div class="form-group">
                    <label for="source_secret_key">Source Secret Access Key</label>
                    <input type="password" id="source_secret_key" name="source_secret_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="source_region">Source Region</label>
                    <input type="text" id="source_region" name="source_region" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="source_bucket">Source Bucket</label>
                    <input type="text" id="source_bucket" name="source_bucket" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="source_prefix">Source Prefix</label>
                    <input type="text" id="source_prefix" name="source_prefix" class="form-control">
                </div>
            </div>
            
            <hr style="margin: 25px 0; border: 1px solid #eee;">
            <h3>Destination Details</h3>
            <div class="form-row">
                 <div class="form-group">
                    <label for="dest_access_key">Destination Access Key ID</label>
                    <input type="password" id="dest_access_key" name="dest_access_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
                <div class="form-group">
                    <label for="dest_secret_key">Destination Secret Access Key</label>
                    <input type="password" id="dest_secret_key" name="dest_secret_key" class="form-control" placeholder="(Optional, uses role if blank)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="dest_region">Destination Region</label>
                    <input type="text" id="dest_region" name="dest_region" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="dest_bucket">Destination Bucket</label>
                    <input type="text" id="dest_bucket" name="dest_bucket" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="dest_prefix">Destination Prefix</label>
                    <input type="text" id="dest_prefix" name="dest_prefix" class="form-control">
                </div>
            </div>

            <!-- This can be a standard submit button now -->
            <button type="submit" class="auth-button" id="startButton">
                <span id="buttonText">ðŸš€ Start Migration</span>
            </button>
        </form>
    </div>

    <!-- Status & Logs Card -->
    <div class="status-card">
        <h2>Live Status</h2>
        <div id="statusContent">
            <!-- Content will be populated by JS when migration starts -->
            <p style="text-align: center; color: #7f8c8d; padding: 20px;">
                Fill out the form and click "Start Migration" to see live progress here.
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const migrationForm = document.getElementById('migrationForm');
    const startButton = document.getElementById('startButton');
    const buttonText = document.getElementById('buttonText');
    const statusContent = document.getElementById('statusContent');
    let isMigrationGloballyRunning = false;
    let eventSource;

    // --- Main function to handle form submission ---
    migrationForm.addEventListener('submit', function(event) {
        // Prevent the default form submission which causes a page reload
        event.preventDefault(); 
        
        if (isMigrationGloballyRunning) {
            alert('A migration is already in progress. Please wait.');
            return;
        }

        // Disable button and show loading state
        startButton.disabled = true;
        buttonText.innerHTML = '<span class="loading-spinner"></span> Initializing...';
        
        // Serialize form data
        const formData = new FormData(migrationForm);

        // Send the POST request to trigger the migration
        fetch("{{ url_for('migration.trigger_migration') }}", {
            method: 'POST',
            body: formData
        })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (!ok) {
                throw new Error(data.message || 'Failed to start migration.');
            }
            // Success! The UI will now update via the SSE stream.
            // The SSE stream will tell us the migration is running, and the button will be updated there.
            console.log('Migration initiated:', data.message);
        })
        .catch(error => {
            console.error('Error triggering migration:', error);
            alert(`Error: ${error.message}`);
            // Re-enable the button on failure
            startButton.disabled = false;
            buttonText.textContent = 'ðŸš€ Start Migration';
        });
    });

    // --- Function to connect to the SSE status stream ---
    function connectToStatusStream() {
        if (eventSource) {
            eventSource.close();
        }
        eventSource = new EventSource("{{ url_for('migration.migration_status_stream') }}");

        eventSource.onopen = () => console.log("Status stream connected.");
        
        eventSource.onmessage = (event) => {
            if (event.data.startsWith(':')) return; // Ignore keep-alive pings
            
            try {
                const status = JSON.parse(event.data);
                updateUI(status);
            } catch (e) {
                console.error("Error parsing status JSON:", e, "Data:", event.data);
            }
        };

        eventSource.onerror = (err) => {
            console.error("Status stream error:", err);
            eventSource.close();
            // Try to reconnect after a delay
            setTimeout(connectToStatusStream, 5000);
        };
    }

    // --- Function to update the entire UI based on received status ---
    function updateUI(status) {
        isMigrationGloballyRunning = status.is_running || false;
        
        // Update button state
        startButton.disabled = isMigrationGloballyRunning;
        if (isMigrationGloballyRunning) {
            buttonText.innerHTML = '<span class="loading-spinner"></span> Migration in Progress...';
        } else {
            buttonText.textContent = 'ðŸš€ Start Migration';
            // You can add logic here for 'Completed' or 'Failed' states if you want
        }

        // Update the status content area
        let progressHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">${(status.total_files || 0).toLocaleString()}</div>
                    <div class="stat-label">Total Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(status.files_completed || 0).toLocaleString()}</div>
                    <div class="stat-label">Transferred</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${formatBytes(status.total_size_bytes || 0)}</div>
                    <div class="stat-label">Total Size</div>
                </div>
                 <div class="stat-card">
                    <div class="stat-value">${(status.files_failed || 0).toLocaleString()}</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <div class="progress-title">Migration Progress</div>
                    <div class="progress-percentage">${Math.round(status.progress || 0)}%</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${status.progress || 0}%">${Math.round(status.progress || 0)}%</div>
                </div>
            </div>
        `;

        if (status.last_log) {
            progressHTML += `
                <div class="current-file">
                    <div class="current-file-label">Last Log:</div>
                    <div class="current-file-name">${status.last_log}</div>
                </div>
            `;
        }

        progressHTML += `
            <div class="log-section">
                <div class="log-header">ðŸ“Š Migration Logs</div>
                <div id="logContainer">
                    ${(status.logs || []).map(log => `<div class="log-entry ${log.level}">${log.message}</div>`).join('')}
                </div>
            </div>
        `;

        statusContent.innerHTML = progressHTML;
        
        // Auto-scroll log container
        const logContainer = document.getElementById('logContainer');
        if (logContainer) {
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    }

    // --- Helper function for formatting bytes ---
    function formatBytes(bytes, decimals = 1) {
        if (!+bytes) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
    }

    // Start listening for status updates as soon as the page loads
    connectToStatusStream();
});
</script>
{% endblock %}